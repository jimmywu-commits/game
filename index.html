<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>è¦çš®å¤¾å¤¾æ¨‚</title>
<style>
@font-face {
  font-family: 'ShopeeNoto';
  src: url('./fonts/ShopeeNotoSans-Regular.ttf') format('truetype');
  font-weight: 400;
  font-style: normal;
}
@font-face {
  font-family: 'ShopeeNoto';
  src: url('./fonts/ShopeeNotoSans-Medium.ttf') format('truetype');
  font-weight: 500;
  font-style: normal;
}
@font-face {
  font-family: 'ShopeeNoto';
  src: url('./fonts/ShopeeNotoSans-Bold.ttf') format('truetype');
  font-weight: 700;
  font-style: normal;
}

/* æµ®å‹•å·¥å…·åˆ— */
.toolbar-float {
  position: fixed;
  top: 8px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  background: rgba(0, 0, 0, 0.7);
  padding: 6px 12px;
  border-radius: 999px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 12px;
}
.toolbar-float .tool-group {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.1);
}
.toolbar-float span {
  white-space: nowrap;
}
.toolbar-float input[type="number"] {
  width: 46px;
  padding: 2px 4px;
  border-radius: 6px;
  border: none;
  font-size: 12px;
  text-align: center;
}
body { padding-top: 60px; }

/* Default: all text bold */
body, div, p, span, strong, .tag-bar, .section-title,
.note, .price-line, .count-line, .date-tag, .sub-label {
  font-family: 'ShopeeNoto', -apple-system, BlinkMacSystemFont, \"Microsoft JhengHei\",
    \"PingFang TC\", \"Helvetica Neue\", Arial, sans-serif;
  font-weight: 700;
}
.note{max-width:1200px;width:100%;margin:0 auto;box-sizing:border-box;overflow-wrap:anywhere;word-break:break-word;}
.note img{max-width:100%;height:auto;}
/* Product Names use Medium */


    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      margin: 0;
      font-family: 'ShopeeNoto', -apple-system, BlinkMacSystemFont, "Microsoft JhengHei",
        "PingFang TC", "Helvetica Neue", Arial, sans-serif;
background: #3566d9;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 1200px;
      margin: 0 auto;
      background: #3566d9;
      padding: 40px 0 60px;
    }

    .panel-outer {
      width: 980px;
      margin: 0 auto;
      background: #ff9b1a;
      border-radius: 26px;
      padding: 20px;
    }

    .panel-inner {
      background: #ffffff;
      border-radius: 20px;
      padding: 26px 32px 36px;
    }

    .tag-bar {
      width: 980px;
      margin: 0 auto 16px;
      background: #ffbe00;
      border-radius: 24px;
      padding: 10px 24px;
      text-align: center;
      color: #ffffff;
      font-size: 50px; /* å¤§æ¨™é¡Œé è¨­ 50px */
      font-weight: 700;
      letter-spacing: 4px;
    }

    .section-title {
      display: inline-block;
      padding: 6px 26px;
      border-radius: 999px;
      background: #ff9b1a;
      color: #ffffff;
      font-size: 47px; /* å€å¡Šæ¨™é¡Œ 47px */
      font-weight: 700;
      margin-bottom: 20px;
		width: 80%;
		margin-top: 
		
		
    }

    .text-center { text-align: center; }

    /* ğŸ”¸ æœ¬æœˆæœ€å¤§çï¼šä¸€ä¸Šä¸€ä¸‹ï¼Œä¸Šä¸‹å…©çµ„ï¼Œå…¨éƒ¨ç½®ä¸­ ğŸ”¸ */
    .big-prize-wrap {
      display: flex;
      flex-direction: column;     /* æ”¹æˆä¸Šä¸‹æ’ */
      align-items: center;        /* ç½®ä¸­ */
      gap: 32px;                  /* ä¸Šä¸‹é–“è· */
      margin-top: 8px;
    }

    .big-prize {
      width: 1000px;               /* è·Ÿåœ“ä¸€æ¨£å¯¬ */
      text-align: center;
    }

    .big-prize-pic {
      width: 420px;               /* 420 x 420 */
      height: 420px;
      border-radius: 50%;
      border: 3px solid #a36537;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #999;
      margin: 0 auto 18px;
    }

    /* è‹¥ä¹‹å¾Œè¦æ”¹æˆåœ–ç‰‡ï¼š
    .big-prize-pic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    */

    .sub-label {
      font-size: 40px; /* è¦–ç‚ºå…§å®¹å­—ï¼Œ29px */
      color: #4a0517;
      font-weight: 700;
    }

    .big-prize-price {
      font-size: 47px;  /* é‡‘é¡ 47px */
      color: #79a8ee;
      font-weight: 700;
      margin-top: 4px;
    }

    .big-prize-info {
      font-size: 47px; /* è¦–ç‚ºå…§å®¹å­—ï¼Œ29px */
      color: #79a8ee;
      margin-top: -10px;
    }

    /* ğŸ”¸ å¤©å¤©å¤¾å“ç‰Œå¤§çå€å¡Š ğŸ”¸ */

    .note {
      font-size: 29px;  /* å…§å®¹ 29px */
      color: #ffffff;
      line-height: 1.7;
      margin-bottom: 16px;
		margin-top: 20px;
		text-align: center;
		width: auto
    }

    .note strong { color: #e85a00; }

    .date-tag {
      display: inline-block;
      margin: 24px auto 10px;
      padding: 4px 100px;
      border-radius: 999px;
      background: #3566d9;
      color: #ffffff;
      font-size: 29px; /* å…§å®¹ 29px */
      font-weight: 700;
    }

    .prize-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      column-gap: 40px;
      row-gap: 28px;
      margin-top: 10px;
    }

    .prize-card {
      width: 44%;
      text-align: center;
    }

    .prize-pic {
      width: 310px;              /* ä½ æŒ‡å®šçš„ 310 x 310 */
      height: 310px;
      margin: 0 auto;
      border-radius: 50%;
      border: 3px solid #a36537;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #999999;
    }

    /* è‹¥æ”¹æˆåœ–ç‰‡ï¼š
    .prize-pic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    */

    .pill {
      display: inline-block;
      margin-top: -12px;
      padding: 6px 30px;
      border-radius: 999px;
      background: #ff9b1a;
      color: #ffffff;
      font-size: 34px; /* å“å 34px */
      font-weight: 700;
      min-width: 180px;
    }

    .price-line {
      font-size: 47px;  /* é‡‘é¡ 47px */
      color: #79a8ee;
      font-weight: 700;
      margin-top: 4px;
    }

    .count-line {
      font-size: 47px;  /* å…§å®¹ 47px */
      color: #79a8ee;
		 margin-top: -10px;
    }

    /* ğŸ”¸ åº•éƒ¨å€å¡Š ğŸ”¸ */

    .footer-panel {
      width: 980px;
      margin: 28px auto 0;
      background: #ff9b1a;
      border-radius: 24px 24px 0 0;
      padding: 20px 30px 32px;
      color: #ffffff;
      text-align: center;
      font-size: 14px;
      line-height: 1.8;
    }

    .coin-btn {
      display: inline-block;
      margin: 30px auto 6px;
      background: #ff6f3c;
      border-radius: 200px;
      padding: 10px 30px;
      font-size: 36px;
      font-weight: 700;
	color: #ffffff;
		width: 80%;
    }

    .legal {
      margin-top: 10px;
      font-size: 12px;
      line-height: 1.7;
    }

.big-prize-name,
.prize-card .prize-name,
.prize-card .name {
  display: inline-block;
  padding: 6px 26px;
  border-radius: 999px;
  background: #f77553;
  color: #ffffff;
  font-size: 47px; /* å“å 34px */
  font-weight: 700;
  margin: 0 auto;
min-width: 700px;
}
.coin-image-wrap {
  margin: 0px auto;       /* ä¸Šä¸‹ 0px + ç½®ä¸­ */
  text-align: center;
}

.coin-image-wrap img {
  width: auto;
  height: 200px;
  display: block;
  margin: 0 auto;          /* åœ–ç‰‡æœ¬èº«ç½®ä¸­ */
}
/* ====== å·¥å…·åˆ—ï¼šæŒ‰éˆ•ç‰ˆï¼ˆå–ä»£å­—ç´šèª¿æ•´ï¼‰ ====== */
.toolbar-float .tool-group{ display:none; } /* éš±è—èˆŠçš„ groupï¼ˆä¿éšªç”¨ï¼‰ */
.toolbar-float .tool-btn{
  appearance:none;
  border: none;
  border-radius: 999px;
  padding: 8px 14px;
  background: rgba(255,255,255,0.14);
  color:#fff;
  font-size: 14px;
  font-family: 'ShopeeNoto';
  cursor:pointer;
  line-height: 1;
}
.toolbar-float .tool-btn:hover{ background: rgba(255,255,255,0.22); }
.toolbar-float .tool-btn:active{ transform: translateY(1px); }
.toolbar-float .tool-btn-secondary{ background: rgba(255,255,255,0.10); }

/* ====== æµ®å‹•ç´°ç¯€èª¿æ•´é¢æ¿ ====== */
.detail-panel{
  position: fixed;
  top: 56px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9998;
  width: 320px;
  background: rgba(0,0,0,0.78);
  border-radius: 18px;
  padding: 12px 12px 10px;
  color:#fff;
  font-family: 'ShopeeNoto';
}
.detail-title{
  font-size: 14px;
  margin-bottom: 8px;
  opacity: 0.95;
}
.detail-row{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 6px 0;
}
.detail-row label{
  font-size: 12px;
  white-space: nowrap;
  opacity: 0.9;
}
.detail-row input, .detail-row select{
  width: 140px;
  padding: 4px 6px;
  border-radius: 8px;
  border: none;
  font-size: 12px;
}
.detail-hint{
  font-size: 11px;
  opacity: 0.75;
  margin-top: 6px;
  line-height: 1.3;
}

/* ====== å¯é¸å–åœ–ç‰‡å€ï¼ˆä¸Šå‚³åœ–ç‰‡å¥—ç”¨ï¼‰ ====== */
.pic-selectable{ cursor: pointer; }
.pic-selected{
  outline: 4px solid rgba(255,255,255,0.85);
  outline-offset: 4px;
}


/* ====== åœ–ç‰‡å‰ªè£æŒ‰éˆ•ï¼ˆicon åœ¨åœ–ç‰‡å·¦å´ã€ä¸å½±éŸ¿åœ–ç‰‡ç½®ä¸­ï¼‰ ====== */
.pic-edit-row{
  position: relative;
  display: block;
  width: fit-content;
  margin: 0 auto 18px; /* ä¿æŒåŸæœ¬ç½®ä¸­ */
}
.pic-edit-row .pic-selectable{
  display:block;
  margin: 0 auto !important;
  position: relative;
}
.pic-edit-btn{
  position: absolute;
  left: -54px; /* åœ¨åœ–ç‰‡å·¦å´å¤–ï¼Œä¸ä½”ç‰ˆä½ */
  top: 50%;
  transform: translateY(-50%);
  width: 44px;
  height: 44px;
  border-radius: 999px;
  border: none;
  background: rgba(0,0,0,0.12);
  cursor: pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}
.pic-edit-btn:hover{ background: rgba(0,0,0,0.18); }
.pic-edit-btn svg{ width: 22px; height: 22px; }

/* ====== åœ–ç‰‡å‰ªè£ Modal ====== */
.crop-modal{
  position: fixed;
  inset: 0;
  z-index: 99999;
  background: rgba(0,0,0,0.72);
  display:none;
  align-items:center;
  justify-content:center;
  padding: 18px;
}
.crop-box{
  width: min(920px, 96vw);
  background: #fff;
  border-radius: 18px;
  padding: 16px;
  box-shadow: 0 16px 40px rgba(0,0,0,0.25);
  font-family: 'ShopeeNoto';
}
.crop-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  margin-bottom: 10px;
}
.crop-title{ font-size: 16px; color:#111; }
.crop-actions{ display:flex; gap: 8px; }
.crop-btn{
  appearance:none;
  border:none;
  border-radius: 999px;
  padding: 10px 14px;
  cursor:pointer;
  font-family: 'ShopeeNoto';
}
.crop-btn.primary{ background:#ff6f3c; color:#fff; }
.crop-btn.secondary{ background: rgba(0,0,0,0.08); color:#111; }
.crop-body{
  display:flex;
  gap: 16px;
  align-items: stretch;
  flex-wrap: wrap;
}

/* ====== æ–‡å­—è¡Œè·ï¼ˆå¯ç”±ç´°ç¯€èª¿æ•´é¢æ¿æ§åˆ¶ï¼‰ ====== */
html{
  --name-line-height: 1.2;
  --price-line-height: 1.15;
}
.big-prize-name,
.pill{
  line-height: var(--name-line-height);
}
.big-prize-price,
.price-line{
  line-height: var(--price-line-height);
}
.crop-canvas-wrap{
  flex: 1 1 520px;
  background: rgba(0,0,0,0.04);
  border-radius: 14px;
  padding: 10px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.crop-controls{
  flex: 0 0 260px;
  display:flex;
  flex-direction:column;
  gap: 10px;
  padding: 6px 4px;
}
.crop-controls label{
  font-size: 12px;
  color:#222;
}
.crop-controls input[type="range"]{ width:100%; }
.crop-hint{
  font-size: 12px;
  color:#444;
  line-height:1.4;
  opacity: 0.9;
}

/* ====== å¾½ç« ï¼šé»‘åº•ç™½å­— 1:1 + å°è©±æ¡†ä¸‰è§’ ====== */
.big-prize-pic{ position: relative; } /* ä½œç‚ºå¾½ç« å®šä½åŸºæº– */

.limit-badge{
  position:absolute;
  top: var(--badge-top, -8px);
  right: var(--badge-right, -26px);
  width: var(--badge-size, 92px);
  height: var(--badge-size, 92px);
  border-radius: 50%;
  background: #000;
  color:#fff;
  display:flex;
  flex-direction: column;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-family:'ShopeeBold';
  font-size: var(--badge-font, 28px);
  line-height: 1.05;
  z-index: 5;
  isolation: isolate;
}
.limit-badge .badge-top{ display:block; }
.limit-badge .badge-bottom{ display:block; }

/* ä¸‰è§’ï¼šé è¨­å·¦ä¸‹ï¼ˆå¯é€é class åˆ‡æ–¹å‘ï¼‰
   éœ€æ±‚ï¼šå·¦å³ç¿»è½‰ + ä¸Šä¸‹ç¿»è½‰ + ç·Šè²¼åº•åœˆï¼ˆåƒå°è©±æ¡†ï¼‰
   æˆ‘é€™è£¡ç”¨ã€Œè²¼åˆå€¼ã€æ§åˆ¶ç·Šè²¼ç¨‹åº¦ï¼ˆ--tail-joinï¼‰ */
.limit-badge::after{
  content:"";
  position:absolute;
    z-index: -1;
width: 0;
  height: 0;
  border-style: solid;
  transform: rotate(var(--tail-angle, 26deg));
}

/* å·¦ä¸‹ï¼šå‘å·¦ä¸‹ä¼¸å‡º */
.limit-badge.dir-bl::after{
  left: var(--tail-left, 10px);
  bottom: calc(-1px + var(--tail-join, 0px));
  border-width: var(--tail-size, 14px) var(--tail-size, 14px) 0 0;
  border-color: #000 transparent transparent transparent;
}

/* å³ä¸‹ï¼šå‘å³ä¸‹ä¼¸å‡ºï¼ˆæ°´å¹³ç¿»è½‰ï¼‰ */
.limit-badge.dir-br::after{
  right: var(--tail-left, 10px);
  bottom: calc(-1px + var(--tail-join, 0px));
  border-width: var(--tail-size, 14px) 0 0 var(--tail-size, 14px);
  border-color: #000 transparent transparent transparent;
}

/* å·¦ä¸Šï¼šå‘å·¦ä¸Šä¼¸å‡ºï¼ˆä¸Šä¸‹ç¿»è½‰ï¼‰ */
.limit-badge.dir-tl::after{
  left: var(--tail-left, 10px);
  top: calc(-1px + var(--tail-join, 0px));
  border-width: 0 var(--tail-size, 14px) var(--tail-size, 14px) 0;
  border-color: transparent transparent #000 transparent;
}

/* å³ä¸Šï¼šå‘å³ä¸Šä¼¸å‡ºï¼ˆæ°´å¹³+ä¸Šä¸‹ç¿»è½‰ï¼‰ */
.limit-badge.dir-tr::after{
  right: var(--tail-left, 10px);
  top: calc(-1px + var(--tail-join, 0px));
  border-width: 0 0 var(--tail-size, 14px) var(--tail-size, 14px);
  border-color: transparent transparent #000 transparent;
}


    /* å·¥å–®ç‰¹è¦ï¼šåªæœ‰Cæ¬„æ™‚ï¼Œè©²çµ„ç½®ä¸­ã€å³é‚Šä¸é¡¯ç¤º */
    .prize-card.hidden { display: none !important; }
    .prize-card.single { grid-column: 1 / -1; justify-self: center; }

/* ====== åœ–ç‰‡ä½”ä½æ–‡å­—ï¼šæ°´å¹³ï¼‹å‚ç›´ç½®ä¸­ ====== */
.pic-placeholder{
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;      /* å‚ç›´ç½®ä¸­ */
  justify-content: center;  /* æ°´å¹³ç½®ä¸­ */
  text-align: center;
  pointer-events: none;     /* ä¸å½±éŸ¿é»æ“Šåœ–ç‰‡æ¡† */
}


/* ====== åœ–ç‰‡ï¼šæ‰‹å‹•æ›åœ–æŒ‰éˆ•ï¼ˆå‰ªåˆ€ä¸‹æ–¹ï¼‰ ====== */
.pic-replace-btn{
  position: absolute;
  left: -54px;            /* èˆ‡å‰ªåˆ€åŒä¸€åˆ— */
  top: calc(50% + 32px);  /* æ’åœ¨å‰ªåˆ€ä¸‹é¢ */
  width: 44px;
  height: 44px;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  display: inline-flex;   /* å¸¸æ…‹é¡¯ç¤º */
  align-items: center;
  justify-content: center;
  z-index: 6;
  background: rgba(0,0,0,0.12);
}
.pic-replace-btn:hover{ background: rgba(0,0,0,0.18); }
.pic-replace-btn svg{ width: 22px; height: 22px; }

</style>
</head>
<body>
<div class="toolbar-float">
<button class="tool-btn" onclick="triggerWorkorderUpload()" type="button">ä¸Šå‚³å·¥å–®</button>
<button class="tool-btn" onclick="triggerImageUpload()" type="button">ä¸Šå‚³åœ–ç‰‡</button>
<button class="tool-btn" onclick="downloadAsImage()" type="button">ä¸‹è¼‰åœ–ç‰‡</button>
<button class="tool-btn tool-btn-secondary" onclick="toggleDetailPanel()" type="button">ç´°ç¯€èª¿æ•´</button>
<!-- hidden inputs -->
<input accept=".xlsx,.xls,.json,.txt" id="workorderInput" style="display:none" type="file"/>
<input accept="image/*" id="imageInput" multiple="" style="display:none" type="file"/>
</div>
<div class="detail-panel" id="detailPanel" style="display:none">
<div class="detail-title">ç´°ç¯€èª¿æ•´</div>
<div class="detail-row">
<label>å¾½ç« æ–‡å­—(ä¸Š)</label>
<input id="badgeTextTop" oninput="applyBadgeText()" type="text" value="æ—¥æœŸ"/>
</div>
<div class="detail-row">
<label>å¾½ç« æ–‡å­—(ä¸‹)</label>
<input id="badgeTextBottom" oninput="applyBadgeText()" type="text" value="é™å®š"/>
</div>
<div class="detail-row">
<label>å¾½ç« å°ºå¯¸</label>
<input id="badgeSize" max="200" min="40" oninput="applyBadgeStyle()" type="number" value="150"/>
</div>
<div class="detail-row">
<label>å¾½ç« å­—ç´š</label>
<input id="badgeFont" max="80" min="10" oninput="applyBadgeStyle()" type="number" value="44"/>
</div>
<div class="detail-row">
<label>å¾½ç« ä¸Šç§»(px)</label>
<input id="badgeTop" max="80" min="-80" oninput="applyBadgeStyle()" type="number" value="42"/>
</div>
<div class="detail-row">
<label>å¾½ç« å³ç§»(px)</label>
<input id="badgeRight" max="120" min="-120" oninput="applyBadgeStyle()" type="number" value="-106"/>
</div>
<div class="detail-row">
<label>ä¸‰è§’å¤§å°</label>
<input id="tailSize" max="40" min="6" oninput="applyBadgeStyle()" type="number" value="40"/>
</div>
<div class="detail-row">
<label>ä¸‰è§’è²¼åˆ(px)</label>
<input id="tailJoin" max="12" min="-12" oninput="applyBadgeStyle()" type="number" value="-1"/>
</div>
<div class="detail-row">
<label>ä¸‰è§’ä½ç½®(å·¦)</label>
<input id="tailLeft" max="80" min="-30" oninput="applyBadgeStyle()" type="number" value="10"/>
</div>
<div class="detail-row">
<label>ä¸‰è§’æ–¹å‘</label>
<select id="tailDir" onchange="applyBadgeStyle()">
<option selected="" value="bl">å·¦ä¸‹</option>
<option value="br">å³ä¸‹</option>
<option value="tl">å·¦ä¸Š</option>
<option value="tr">å³ä¸Š</option>
</select>
</div>
<div class="detail-row">
<label>ä¸‰è§’è§’åº¦(Â°)</label>
<input id="tailAngle" max="180" min="-180" oninput="applyBadgeStyle()" type="number" value="26"/>
</div>
<div class="detail-row"><label>åƒ¹æ ¼è¡Œè·</label><input id="priceLineHeight" max="2.0" min="0.8" oninput="applyTextLineHeight()" step="0.05" type="number" value="1.15"/></div><div class="detail-row"><label>å“åè¡Œè·</label><input id="nameLineHeight" max="2.0" min="0.8" oninput="applyTextLineHeight()" step="0.05" type="number" value="1.2"/></div><div class="detail-hint">æç¤ºï¼šå…ˆæ”¹æ•¸å€¼çœ‹æ•ˆæœï¼›ä¸‹è¼‰åœ–ç‰‡æœƒè¼¸å‡ºæ•´é ã€‚</div>
</div><div class="page">
<!-- start -->
	<!-- tag-bar#1 -->
<div class="tag-bar">å¤§é¡æ¨™</div>
<div class="panel-outer">
<div class="panel-inner text-center">
<div class="section-title">ä¸­é¡æ¨™</div>
<div class="sub-label">å°é¡æ¨™</div>
<!-- â­ é€™è£¡å·²æ”¹æˆã€Œä¸Šä¸‹å…©çµ„ã€å„è‡ªåœ–åœ¨ä¸Šæ–‡å­—åœ¨ä¸‹ã€ â­ -->
<div class="big-prize-wrap">
<!-- ç¬¬ä¸€çµ„ï¼šSwitch -->
<div class="big-prize">
<div class="big-prize-pic pic-selectable">
<div class="limit-badge dir-bl"><span class="badge-top">å·¦ä¸Šè§’æ¨™è¨˜</span><span class="badge-bottom">é™å®š</span></div>
<div class="pic-placeholder">åœ–ç‰‡å€</div></div>
<div class="big-prize-name">å“åèˆ‡åœ–ç‰‡åç¨±Â </div>
<div class="big-prize-price">åƒ¹å€¼ $0,000</div>
<div class="big-prize-info">å…± 0 å</div>
</div>
<!-- ç¬¬äºŒçµ„ï¼šå•†å“ -->
<div class="big-prize">
<div class="big-prize-pic pic-selectable">
<div class="limit-badge dir-bl"><span class="badge-top">å·¦ä¸Šè§’æ¨™è¨˜</span><span class="badge-bottom">é™å®š</span></div>
<div class="pic-placeholder">åœ–ç‰‡å€</div></div>
<div class="big-prize-name">å“åèˆ‡åœ–ç‰‡åç¨±Â </div>
<div class="big-prize-price">åƒ¹å€¼ $0,000</div>
<div class="big-prize-info">å…± 0 å</div>
</div>
</div>
</div>
</div>
<!-- ä¸‹æ–¹ï¼šå¤©å¤©å¤¾å“ç‰Œå¤§ç -->
<div style="height:16px;"></div>
<div class="panel-outer">
<div class="panel-inner text-center">
<div class="section-title">ä¸­é¡æ¨™</div>
<div class="sub-label">å°é¡æ¨™</div>
<!-- æ—¥æœŸ -->
<div class="date-tag">æ—¥æœŸ</div>
<!-- æ¯æ’ -->
<div class="prize-grid">
<div class="prize-card">
<div class="prize-pic pic-selectable"> </div>
<div class="pill">å“å</div>
<div class="price-line">åƒ¹å€¼ $000</div>
<div class="count-line">å…± 000 å</div>
</div>
<div class="prize-card">
<div class="prize-pic pic-selectable"> </div>
<div class="pill">å“å</div>
<div class="price-line">åƒ¹å€¼ $000</div>
<div class="count-line">å…± 000 å</div>
</div>
</div>
<div class="section-title" style="margin-top: 80px;">ä¸­é¡æ¨™</div>
<div class="coin-image-wrap">
<img alt="è¦å¹£åœ–ç‰‡" src="./ç¨‹å¼æª”æ¡ˆ/è¦å¹£icon.png" data-protect-image="1"/>
</div>
<div class="coin-btn">
<p>è¦å¹£å…§å®¹</p>
</div>
</div>
</div>
<div class="note" style="width:80%;">
å…§å®¹</div>

</div>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
let __selectedPicEl = null;

function setSelectedPic(el){
  document.querySelectorAll('.pic-selected').forEach(x=>x.classList.remove('pic-selected'));
  __selectedPicEl = el;
  if(el) el.classList.add('pic-selected');
}

function initPicSelection(){
  document.querySelectorAll('.pic-selectable').forEach(el=>{
    if(el.dataset.picSelectableBound === '1') return;
    el.dataset.picSelectableBound = '1';
    el.addEventListener('click', ()=> setSelectedPic(el));
  });
}



let __cropModal = null;
let __cropCanvas = null;
let __cropCtx = null;
let __cropImg = null;
let __cropState = {base: 1, zoom: 1, x: 0, y: 0, dragging: false, lastX: 0, lastY: 0, size: 420, mode:'move', workCanvas:null, workCtx:null};

function svgScissors(){
  return `
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <circle cx="6" cy="6" r="3"></circle>
    <circle cx="6" cy="18" r="3"></circle>
    <line x1="20" y1="4" x2="8.12" y2="15.88"></line>
    <line x1="14.47" y1="14.48" x2="20" y2="20"></line>
    <line x1="8.12" y1="8.12" x2="12" y2="12"></line>
  </svg>`;
}

function ensurePicEditorUI(){
  document.querySelectorAll('.pic-selectable').forEach(pic=>{
    if(pic.closest('.pic-edit-row')) return;

    const row = document.createElement('div');
    row.className = 'pic-edit-row';

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'pic-edit-btn';
    // btn.title = 'è£åˆ‡ / æ”¾å¤§ç¸®å°';
    btn.innerHTML = svgScissors();

    // è¨­å®š sizeï¼ˆç”¨æ–¼è£åˆ‡è¼¸å‡ºè§£æåº¦ï¼‰
    const rect = pic.getBoundingClientRect();
    const size = Math.round(Math.max(rect.width || 0, rect.height || 0));
    pic.dataset.cropSize = String(size || 420);

    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      openCropModal(pic);
    });

    // ç”¨ row å–ä»£åŸæœ¬ä½ç½®
    const parent = pic.parentNode;
    parent.insertBefore(row, pic);
    row.appendChild(btn);
    row.appendChild(pic);
  });
}

function createCropModal(){
  const modal = document.createElement('div');
  modal.className = 'crop-modal';
  modal.id = 'cropModal';
  modal.innerHTML = `
    <div class="crop-box">
      <div class="crop-head">
        <div class="crop-title">åœ–ç‰‡ç·¨è¼¯ï¼ˆæ‹–æ›³ç§»å‹•ã€æ‹‰æ¡¿ç¸®æ”¾ï¼‰</div>
        <div class="crop-actions">
          <button class="crop-btn secondary" type="button" id="cropCancelBtn">å–æ¶ˆ</button>
          <button class="crop-btn primary" type="button" id="cropApplyBtn">å¥—ç”¨</button>
        </div>
      </div>
      <div class="crop-body">
        <div class="crop-canvas-wrap">
          <canvas id="cropCanvas" width="520" height="520"></canvas>
        </div>
        <div class="crop-controls">
          <div>
            <label>ç¸®æ”¾</label>
            <input id="cropZoom" type="range" min="0.5" max="1.5" step="0.01" value="1" />
          </div>
          <div class="crop-mode">
            <label style="margin-right:10px"><input type="radio" name="cropMode" value="move" checked> ç§»å‹•/ç¸®æ”¾</label>
            <label><input type="radio" name="cropMode" value="smart"> æ™ºæ…§é¸å–</label>
            <label><input type="radio" name="cropMode" value="erase"> æ“¦é™¤</label>
            
          </div>
          <div class="crop-smart" style="display:none">
            <label>å®¹å·®</label>
            <input id="cropTol" type="range" min="0" max="80" step="1" value="20" />
            <button class="crop-btn secondary" type="button" id="cropSmartResetBtn" style="margin-left:8px">é‡ä½œ</button>
          </div>
          <div class="crop-erase" style="display:none">
            <label>ç­†åˆ·</label>
            <input id="eraseSize" type="range" min="6" max="80" step="1" value="24" />
            <button class="crop-btn secondary" type="button" id="eraseResetBtn" style="margin-left:8px">é‡ä½œ</button>
          </div>

          <div class="crop-crop" style="display:none">
            <div style="font-size:12px;opacity:.9">æ‹–æ›³æ¡†é¸è£åˆ‡ç¯„åœ</div>
            <button class="crop-btn secondary" type="button" id="cropSelClearBtn" style="margin-left:8px">æ¸…é™¤</button>
          </div>


          <div class="crop-hint">
            1) å…ˆä¸Šå‚³åœ–ç‰‡<br/>
            2) é»å·¦å´å‰ªåˆ€ â†’ é€²å…¥ç·¨è¼¯<br/>
            3) ç›´æ¥æ‹–æ›³åœ–ç‰‡ä½ç½®ã€ç”¨æ»‘æ¡¿ç¸®æ”¾<br/>
            4) å¥—ç”¨å¾Œæœƒæ›´æ–°åˆ°è©²åœ–ç‰‡æ¡†
          </div>
        </div>
      </div>
    </div>
  `;
  modal.addEventListener('click', (e)=>{
    if(e.target === modal) closeCropModal();
  });
  document.body.appendChild(modal);

  const canvas = modal.querySelector('#cropCanvas');
  const ctx = canvas.getContext('2d');
  __cropModal = modal;
  __cropCanvas = canvas;
  __cropCtx = ctx;

  const zoom = modal.querySelector('#cropZoom');
  zoom.addEventListener('input', ()=>{
    __cropState.zoom = parseFloat(zoom.value) || 1;
    // å¯¦éš›ç¸®æ”¾ = base * zoom
    
    redrawCrop();
  });
  // æ¨¡å¼åˆ‡æ›ï¼šç§»å‹•/ç¸®æ”¾ vs æ™ºæ…§é¸å–
  const smartWrap = modal.querySelector('.crop-smart');
  const eraseWrap = modal.querySelector('.crop-erase');
  const cropWrap  = modal.querySelector('.crop-crop');
  const setModeUI = ()=>{
    if(smartWrap) smartWrap.style.display = (__cropState.mode === 'smart') ? 'flex' : 'none';
    if(eraseWrap) eraseWrap.style.display = (__cropState.mode === 'erase') ? 'flex' : 'none';
    if(cropWrap)  cropWrap.style.display  = (__cropState.mode === 'crop')  ? 'flex' : 'none';
  };
  modal.querySelectorAll('input[name="cropMode"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      __cropState.mode = r.value;
      setModeUI();
      redrawCrop();
    });
  });
  if(smartWrap){
    smartWrap.style.alignItems = 'center';
    smartWrap.style.gap = '8px';
    smartWrap.style.marginTop = '8px';
  }
  if(eraseWrap){
    eraseWrap.style.alignItems = 'center';
    eraseWrap.style.gap = '8px';
    eraseWrap.style.marginTop = '8px';
  }
  if(cropWrap){
    cropWrap.style.alignItems = 'center';
    cropWrap.style.gap = '8px';
    cropWrap.style.marginTop = '8px';
  }
  setModeUI();
  const tolEl = modal.querySelector('#cropTol');

  // æ™ºæ…§é¸å–ï¼ˆflood fillï¼‰ï¼šé»æ“Šè¦å»èƒŒçš„å€åŸŸ
  function floodSelectOnWorkCanvas(ix, iy, tol){
    const wc = __cropState.workCanvas;
    const wctx = __cropState.workCtx;
    if(!wc || !wctx) return;
    const w = wc.width, h = wc.height;
    const x = Math.max(0, Math.min(w-1, Math.round(ix)));
    const y = Math.max(0, Math.min(h-1, Math.round(iy)));
    const img = wctx.getImageData(0,0,w,h);
    const data = img.data;
    const idx0 = (y*w + x)*4;
    const seed = [data[idx0], data[idx0+1], data[idx0+2], data[idx0+3]];
    const within = (i)=> Math.abs(data[i]-seed[0])<=tol && Math.abs(data[i+1]-seed[1])<=tol && Math.abs(data[i+2]-seed[2])<=tol && Math.abs(data[i+3]-seed[3])<=tol;
    const q = [[x,y]];
    const visited = new Uint8Array(w*h);
    while(q.length){
      const [cx,cy] = q.pop();
      const p = cy*w + cx;
      if(visited[p]) continue;
      visited[p]=1;
      const i = p*4;
      if(!within(i)) continue;
      data[i+3]=0;
      if(cx>0) q.push([cx-1,cy]);
      if(cx<w-1) q.push([cx+1,cy]);
      if(cy>0) q.push([cx,cy-1]);
      if(cy<h-1) q.push([cx,cy+1]);
    }
    wctx.putImageData(img,0,0);
  }

  canvas.addEventListener('click', (e)=>{
    if(__cropState.mode !== 'smart') return;
    if(!__cropImg || !__cropState.workCanvas) return;

    const cw = __cropCanvas.width, ch = __cropCanvas.height;
    const x0 = cw/2 + __cropState.x;
    const y0 = ch/2 + __cropState.y;
    const scale = (__cropState.base || 1) * (__cropState.zoom || 1);

    const src = __cropState.workCanvas;
    const sw = src.width, sh = src.height;

    const localX = (e.offsetX - x0) / scale + sw/2;
    const localY = (e.offsetY - y0) / scale + sh/2;

    floodSelectOnWorkCanvas(localX, localY, Number(tolEl?.value || 20));
    redrawCrop();
  });

  // é‡ä½œï¼šå›åˆ°åŸåœ–ï¼ˆä¿ç•™ç§»å‹•/ç¸®æ”¾ç‹€æ…‹ï¼‰
  modal.querySelector('#cropSmartResetBtn')?.addEventListener('click', ()=>{
    if(!__cropImg) return;
    const wc = document.createElement('canvas');
    wc.width = __cropImg.naturalWidth || __cropImg.width;
    wc.height = __cropImg.naturalHeight || __cropImg.height;
    const wctx = wc.getContext('2d');
    wctx.drawImage(__cropImg, 0, 0);
    __cropState.workCanvas = wc;
    __cropState.workCtx = wctx;
    redrawCrop();
  });


  
  // æ“¦é™¤ï¼šé‡ä½œï¼ˆå›åˆ°åŸåœ–ï¼Œä¿ç•™ç§»å‹•/ç¸®æ”¾ç‹€æ…‹ï¼‰
  modal.querySelector('#eraseResetBtn')?.addEventListener('click', ()=>{
    if(!__cropImg) return;
    const wc = document.createElement('canvas');
    wc.width = __cropImg.naturalWidth || __cropImg.width;
    wc.height = __cropImg.naturalHeight || __cropImg.height;
    const wctx = wc.getContext('2d');
    wctx.drawImage(__cropImg, 0, 0);
    __cropState.workCanvas = wc;
    __cropState.workCtx = wctx;
    redrawCrop();
  });

  // è£åˆ‡ï¼šæ¸…é™¤é¸å–æ¡†
  modal.querySelector('#cropSelClearBtn')?.addEventListener('click', ()=>{
    __cropState.cropSel = null;
    redrawCrop();
  });

modal.querySelector('#cropCancelBtn').addEventListener('click', closeCropModal);
  modal.querySelector('#cropApplyBtn').addEventListener('click', applyCropToTarget);

  // drag / tool interaction
  function canvasToWorkXY(cx, cy){
    const cw = __cropCanvas.width, ch = __cropCanvas.height;
    const x0 = cw/2 + __cropState.x;
    const y0 = ch/2 + __cropState.y;
    const scale = (__cropState.base || 1) * (__cropState.zoom || 1);
    const src = (__cropState.workCanvas || __cropImg);
    const sw = src.width, sh = src.height;
    const localX = (cx - x0) / scale + sw/2;
    const localY = (cy - y0) / scale + sh/2;
    return { localX, localY, scale, sw, sh };
  }

  function ensureWorkCanvas(){
    if(__cropState.workCanvas && __cropState.workCtx) return;
    if(!__cropImg) return;
    const wc = document.createElement('canvas');
    wc.width = __cropImg.naturalWidth || __cropImg.width;
    wc.height = __cropImg.naturalHeight || __cropImg.height;
    const wctx = wc.getContext('2d');
    wctx.drawImage(__cropImg, 0, 0);
    __cropState.workCanvas = wc;
    __cropState.workCtx = wctx;
  }

  function eraseAt(cx, cy){
    ensureWorkCanvas();
    const wc = __cropState.workCanvas;
    const wctx = __cropState.workCtx;
    if(!wc || !wctx) return;
    const {localX, localY, scale} = canvasToWorkXY(cx, cy);
    const rCanvas = Number(modal.querySelector('#eraseSize')?.value || 24);
    const r = Math.max(1, rCanvas / Math.max(scale, 0.0001));
    wctx.save();
    wctx.globalCompositeOperation = 'destination-out';
    wctx.beginPath();
    wctx.arc(localX, localY, r, 0, Math.PI*2);
    wctx.fill();
    wctx.restore();
  }

  function drawCropSelectionOverlay(){
    if(__cropState.mode !== 'crop') return;
    const sel = __cropState.cropSel;
    if(!sel || sel.w < 2 || sel.h < 2) return;
    const ctx = __cropCtx;
    ctx.save();
    ctx.strokeStyle = '#00a3ff';
    ctx.lineWidth = 2;
    ctx.setLineDash([6,4]);
    ctx.strokeRect(sel.x, sel.y, sel.w, sel.h);
    ctx.fillStyle = 'rgba(0,163,255,0.12)';
    ctx.fillRect(sel.x, sel.y, sel.w, sel.h);
    ctx.restore();
  }

  // hook overlay into redraw
  const __oldRedrawCrop = redrawCrop;
  redrawCrop = function(){
    __oldRedrawCrop();
    drawCropSelectionOverlay();
  };

  canvas.addEventListener('mousedown', (e)=>{
    if(__cropState.mode === 'move' || __cropState.mode === 'smart'){
      __cropState.dragging = true;
      __cropState.lastX = e.offsetX;
      __cropState.lastY = e.offsetY;
      return;
    }
    if(__cropState.mode === 'erase'){
      __cropState.dragging = true;
      eraseAt(e.offsetX, e.offsetY);
      redrawCrop();
      return;
    }
    if(__cropState.mode === 'crop'){
      __cropState.selecting = true;
      __cropState.selStartX = e.offsetX;
      __cropState.selStartY = e.offsetY;
      __cropState.cropSel = {x:e.offsetX, y:e.offsetY, w:0, h:0};
      redrawCrop();
      return;
    }
  });

  window.addEventListener('mouseup', ()=>{
    __cropState.dragging = false;
    __cropState.selecting = false;
  });

  canvas.addEventListener('mousemove', (e)=>{
    if(__cropState.mode === 'move' || __cropState.mode === 'smart'){
      if(!__cropState.dragging) return;
      const dx = e.offsetX - __cropState.lastX;
      const dy = e.offsetY - __cropState.lastY;
      __cropState.lastX = e.offsetX;
      __cropState.lastY = e.offsetY;
      __cropState.x += dx;
      __cropState.y += dy;
      redrawCrop();
      return;
    }
    if(__cropState.mode === 'erase'){
      if(!__cropState.dragging) return;
      eraseAt(e.offsetX, e.offsetY);
      redrawCrop();
      return;
    }
    if(__cropState.mode === 'crop'){
      if(!__cropState.selecting) return;
      const x = Math.min(__cropState.selStartX, e.offsetX);
      const y = Math.min(__cropState.selStartY, e.offsetY);
      const w = Math.abs(e.offsetX - __cropState.selStartX);
      const h = Math.abs(e.offsetY - __cropState.selStartY);
      __cropState.cropSel = {x,y,w,h};
      redrawCrop();
      return;
    }
  });
return modal;
}

function getBgUrl(el){
  const bg = (el.style.backgroundImage || '').trim();
  const m = bg.match(/url\(["']?(.*?)["']?\)/i);
  return m ? m[1] : '';
}

let __cropTargetEl = null;

function openCropModal(picEl){
  const url = picEl.dataset.originalUrl || getBgUrl(picEl);
  if(!url){
    alert('æ­¤åœ–ç‰‡æ¡†å°šæœªæœ‰åœ–ç‰‡ï¼Œè«‹å…ˆä¸Šå‚³åœ–ç‰‡ã€‚');
    return;
  }
  if(!__cropModal) createCropModal();

  __cropTargetEl = picEl;
  __cropState.size = parseInt(picEl.dataset.cropSize || '420', 10) || 420;

  const img = new Image();
  img.onload = ()=>{
    __cropImg = img;

    // å»ºç«‹å·¥ä½œç•«å¸ƒï¼ˆæ™ºæ…§é¸å–æœƒåœ¨æ­¤ç•«å¸ƒä¸Šå»èƒŒï¼‰
    const wc = document.createElement('canvas');
    wc.width = img.naturalWidth || img.width;
    wc.height = img.naturalHeight || img.height;
    const wctx = wc.getContext('2d');
    wctx.drawImage(img, 0, 0);
    __cropState.workCanvas = wc;
    __cropState.workCtx = wctx;

    // åˆå§‹åŒ–ï¼šå…ˆè¨ˆç®—ã€Œå‰›å¥½è¦†è“‹è£åˆ‡æ¡†ã€çš„ baseï¼Œå†ç”¨ zoom(0.5~1.5) ä¾†åšç›¸å°ç¸®æ”¾
    const cw = __cropCanvas.width;
    const ch = __cropCanvas.height;
    const base = Math.max(cw / img.width, ch / img.height);
    __cropState.base = base;

    // ä¾éœ€æ±‚ï¼šæ‹‰æ¡¿é è¨­åœ¨ä¸­é–“(1.0)ï¼Œå¯ -50% / +50%
    __cropState.zoom = 1.0;
    __cropState.x = 0;
    __cropState.y = 0;

    const zoom = __cropModal.querySelector('#cropZoom');
    zoom.value = '1';
    redrawCrop();

    __cropModal.style.display = 'flex';
  };
  img.onerror = ()=>{
    alert('åœ–ç‰‡è®€å–å¤±æ•—ï¼Œè«‹é‡æ–°ä¸Šå‚³ã€‚');
  };
  img.src = url;
}

function closeCropModal(){
  if(__cropModal) __cropModal.style.display = 'none';
  __cropTargetEl = null;
}

function redrawCrop(){
  if(!__cropCtx || !__cropCanvas) return;
  const ctx = __cropCtx;
  const cw = __cropCanvas.width;
  const ch = __cropCanvas.height;

  ctx.clearRect(0,0,cw,ch);

  // å…ˆç•«åº•
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,cw,ch);

  if(!__cropImg) return;

  // ç½®ä¸­ç‚ºåŸºæº– + åç§»
  const x = cw/2 + __cropState.x;
  const y = ch/2 + __cropState.y;

  const scale = (__cropState.base || 1) * (__cropState.zoom || 1);

  const src = (__cropState.workCanvas || __cropImg);
  const sw = src.width;
  const sh = src.height;
  const w = sw * scale;
  const h = sh * scale;

  ctx.save();
  ctx.translate(x, y);
  ctx.drawImage(src, -w/2, -h/2, w, h);
  ctx.restore();

  // è£åˆ‡æ¡†æç¤ºï¼ˆåœ“å½¢ï¼‰
  ctx.save();
  ctx.globalCompositeOperation = 'source-over';
  ctx.strokeStyle = 'rgba(0,0,0,0.35)';
  ctx.lineWidth = 3;
  const r = Math.min(cw, ch)/2 - 8;
  ctx.beginPath();
  ctx.arc(cw/2, ch/2, r, 0, Math.PI*2);
  ctx.stroke();
  ctx.restore();
}

function applyCropToTarget(){
  if(!__cropTargetEl || !__cropCanvas) return;

  // è£åˆ‡ï¼ˆçŸ©å½¢ï¼‰ï¼šå…ˆæŠŠ workCanvas è£æˆé¸å–æ¡†ï¼Œå†ä»¥æ–°å·¥ä½œåœ–ç¹¼çºŒå¥—ç”¨ï¼ˆæ²¿ç”¨åŸæœ¬ã€Œåœ“å½¢è¼¸å‡ºã€è¦å‰‡ï¼‰
  if(__cropState.mode === 'crop' && __cropState.cropSel && __cropState.cropSel.w > 2 && __cropState.cropSel.h > 2 && __cropState.workCanvas){
    const sel = __cropState.cropSel;
    const cw = __cropCanvas.width, ch = __cropCanvas.height;
    const x0 = cw/2 + __cropState.x;
    const y0 = ch/2 + __cropState.y;
    const scale = (__cropState.base || 1) * (__cropState.zoom || 1);
    const src = __cropState.workCanvas;
    const sw = src.width, sh = src.height;

    // è½‰æˆ workCanvas åº§æ¨™
    let sx = (sel.x - x0) / scale + sw/2;
    let sy = (sel.y - y0) / scale + sh/2;
    let ex = (sel.x + sel.w - x0) / scale + sw/2;
    let ey = (sel.y + sel.h - y0) / scale + sh/2;

    // æ­£è¦åŒ– & clamp
    let x1 = Math.max(0, Math.min(sw, Math.min(sx, ex)));
    let y1 = Math.max(0, Math.min(sh, Math.min(sy, ey)));
    let x2 = Math.max(0, Math.min(sw, Math.max(sx, ex)));
    let y2 = Math.max(0, Math.min(sh, Math.max(sy, ey)));

    const w2 = Math.max(1, Math.floor(x2 - x1));
    const h2 = Math.max(1, Math.floor(y2 - y1));

    const outWc = document.createElement('canvas');
    outWc.width = w2;
    outWc.height = h2;
    const outCtx = outWc.getContext('2d');
    outCtx.drawImage(src, x1, y1, w2, h2, 0, 0, w2, h2);

    __cropState.workCanvas = outWc;
    __cropState.workCtx = outCtx;

    // é‡æ–°è¨ˆç®— base / reset ä½ç§»ç¸®æ”¾ï¼Œè®“è£åˆ‡å¾Œçš„åœ–å›åˆ°ç½®ä¸­å¯èª¿
    __cropState.x = 0;
    __cropState.y = 0;
    __cropState.zoom = 1.0;
    __cropState.base = Math.max(cw / outWc.width, ch / outWc.height);
    const zoomEl = __cropModal?.querySelector('#cropZoom');
    if(zoomEl) zoomEl.value = '1';

    // æ¸…æ‰é¸å–æ¡†
    __cropState.cropSel = null;
    // é‡æ–°ç¹ªè£½ä¸€æ¬¡ï¼ˆå¯é¿å…é‚Šç•Œé–ƒçˆï¼‰
    redrawCrop();
  }


  // å–å‡ºä¸­å¿ƒåœ“å½¢è£åˆ‡ â†’ è¼¸å‡ºæˆæ­£æ–¹å½¢ï¼Œå†ç”¨ CSS åœ“å½¢é¡¯ç¤º
  const outSize = __cropState.size || 420;
  const out = document.createElement('canvas');
  out.width = outSize;
  out.height = outSize;
  const octx = out.getContext('2d');

  // ç™½åº•ï¼ˆé¿å…ç¸®å°å¾Œå‡ºç¾ç°åº•ï¼‰
  octx.fillStyle = '#ffffff';
  octx.fillRect(0,0,outSize,outSize);

  // æŠŠ cropCanvas çš„ä¸­å¿ƒå€åŸŸç¸®æ”¾åˆ° out
  const cw = __cropCanvas.width;
  const ch = __cropCanvas.height;
  const srcSize = Math.min(cw, ch) - 16; // èˆ‡æç¤ºåœˆä¸€è‡´
  const sx = (cw - srcSize)/2;
  const sy = (ch - srcSize)/2;

  // åœ“å½¢é®ç½©
  octx.save();
  octx.beginPath();
  octx.arc(outSize/2, outSize/2, outSize/2, 0, Math.PI*2);
  octx.closePath();
  octx.clip();

  octx.drawImage(__cropCanvas, sx, sy, srcSize, srcSize, 0, 0, outSize, outSize);
  octx.restore();

  const dataUrl = out.toDataURL('image/png');
  __cropTargetEl.style.backgroundImage = `url("${dataUrl}")`;
  __cropTargetEl.style.backgroundSize = 'cover';
  __cropTargetEl.style.backgroundPosition = 'center';
  // åªç§»é™¤ placeholderï¼Œä¸è¦å‹•åˆ° badge/å…¶ä»–å­ç¯€é»
  __cropTargetEl.querySelectorAll('.pic-placeholder').forEach(n=>n.remove());
  // ç§»é™¤ç´”æ–‡å­— 'åœ–ç‰‡å€'ï¼ˆè‹¥æœ‰ï¼‰
  Array.from(__cropTargetEl.childNodes).forEach(n=>{
    if(n.nodeType === 3 && (n.textContent || '').trim() === 'åœ–ç‰‡å€') n.remove();
  });
  __cropTargetEl.dataset.croppedUrl = dataUrl;

  closeCropModal();
}



// ====== inline åœ–ç‰‡æ›¿æ›ï¼ˆåªè™•ç†æ–‡å­—ä¸­çš„æª”åï¼Œä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½ï¼‰ ======
// è¦å‰‡ï¼šåªæ›¿æ›è¢«é›™å¼•è™Ÿæ¡†èµ·ä¾†çš„æª”åï¼Œä¾‹å¦‚ï¼š"ç¦.png"ï¼›å–ä»£æ™‚é€£åŒå¼•è™Ÿä¸€èµ·å–ä»£
function replaceInlineFilenameWithImage(containerEl, filename, url){
  if(!containerEl || !filename || !url) return;
  if(containerEl.closest('.toolbar-float') || containerEl.closest('.detail-panel') || containerEl.closest('.crop-modal')) return;

  const escapeRegExp = (s)=> (s || '').toString().replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

  // åªåŒ¹é…è¢«é›™å¼•è™Ÿæ¡†ä½çš„æª”åï¼ˆå¤§å°å¯«ä¸æ•æ„Ÿï¼Œç”¨æ–¼æ”¯æ´ ç¦.PNG / ç¦.pngï¼‰
  const pat = '"' + escapeRegExp(filename.toString()) + '"';
  const testRe = new RegExp(pat, 'i');
  const replRe = new RegExp(pat, 'gi');

  const walker = document.createTreeWalker(containerEl, NodeFilter.SHOW_TEXT, {
    acceptNode(node){
      return node.nodeValue && testRe.test(node.nodeValue)
        ? NodeFilter.FILTER_ACCEPT
        : NodeFilter.FILTER_REJECT;
    }
  });

  const nodes = [];
  while(walker.nextNode()) nodes.push(walker.currentNode);

  nodes.forEach(tn=>{
    const text = tn.nodeValue || '';
    let last = 0;
    let match;
    const frag = document.createDocumentFragment();

    replRe.lastIndex = 0;
    while((match = replRe.exec(text)) !== null){
      const idx = match.index;
      const end = idx + match[0].length;

      const before = text.slice(last, idx);
      if(before) frag.appendChild(document.createTextNode(before));

      const img = document.createElement('img');
      img.src = url;
      img.alt = filename.toString();
      img.style.height = '1.1em';          // +10%
      img.style.verticalAlign = 'middle';
      img.style.display = 'inline-block';
      img.style.margin = '0 2px';
      frag.appendChild(img);

      last = end;
    }

    const after = text.slice(last);
    if(after) frag.appendChild(document.createTextNode(after));

    tn.parentNode.replaceChild(frag, tn);
  });
}


function triggerImageUpload(){
  const input = document.getElementById('imageInput');
  if(!input) return;
  input.value = '';
  input.click();
}

function triggerWorkorderUpload(){
  const input = document.getElementById('workorderInput');
  if(!input) return;
  input.value = '';
  input.click();
}

function toggleDetailPanel(){
  const p = document.getElementById('detailPanel');
  if(!p) return;
  p.style.display = (p.style.display === 'none' || p.style.display === '') ? 'block' : 'none';
}

/* å·¥å–®ï¼šç°¡å–® JSON å¥—ç”¨ï¼ˆå¯æ“´å……ï¼‰ */
function applyWorkorder(data){
  const map = {
    bigPrize1Name: '.big-prize-wrap .big-prize:nth-of-type(1) .big-prize-name',
    bigPrize1Price: '.big-prize-wrap .big-prize:nth-of-type(1) .big-prize-price',
    bigPrize1Info: '.big-prize-wrap .big-prize:nth-of-type(1) .big-prize-info',
    bigPrize2Name: '.big-prize-wrap .big-prize:nth-of-type(2) .big-prize-name',
    bigPrize2Price: '.big-prize-wrap .big-prize:nth-of-type(2) .big-prize-price',
    bigPrize2Info: '.big-prize-wrap .big-prize:nth-of-type(2) .big-prize-info',
  };
  Object.keys(map).forEach(k=>{
    if(data && typeof data[k] !== 'undefined'){
      const el = document.querySelector(map[k]);
      if(el) el.textContent = String(data[k]);
    }
  });
}

function applyBadgeText(){
  const top = document.getElementById('badgeTextTop')?.value ?? 'æ—¥æœŸ';
  const bottom = document.getElementById('badgeTextBottom')?.value ?? 'é™å®š';
  document.querySelectorAll('.limit-badge .badge-top').forEach(el=>el.textContent = top);
  document.querySelectorAll('.limit-badge .badge-bottom').forEach(el=>el.textContent = bottom);
}

function applyBadgeStyle(){
  const size = parseFloat(document.getElementById('badgeSize')?.value ?? 92);
  const font = parseFloat(document.getElementById('badgeFont')?.value ?? 28);
  const top = parseFloat(document.getElementById('badgeTop')?.value ?? -8);
  const right = parseFloat(document.getElementById('badgeRight')?.value ?? -26);
  const tailSize = parseFloat(document.getElementById('tailSize')?.value ?? 14);
  const tailJoin = parseFloat(document.getElementById('tailJoin')?.value ?? 0);
  const tailLeft = parseFloat(document.getElementById('tailLeft')?.value ?? 10);
  const dir = document.getElementById('tailDir')?.value ?? 'bl';

  document.querySelectorAll('.limit-badge').forEach(b=>{
    b.style.setProperty('--badge-size', size + 'px');
    b.style.setProperty('--badge-font', font + 'px');
    b.style.setProperty('--badge-top', top + 'px');
    b.style.setProperty('--badge-right', right + 'px');
    b.style.setProperty('--tail-size', tailSize + 'px');
    b.style.setProperty('--tail-join', tailJoin + 'px');
    b.style.setProperty('--tail-left', tailLeft + 'px');

    
    const angle = parseFloat(document.getElementById('tailAngle')?.value ?? 22);
    b.style.setProperty('--tail-angle', angle + 'deg');
b.classList.remove('dir-bl','dir-br','dir-tl','dir-tr');
    b.classList.add('dir-' + dir);
  });
}


function applyTextLineHeight(){
  const nameLH = parseFloat(document.getElementById('nameLineHeight')?.value ?? 1.2);
  const priceLH = parseFloat(document.getElementById('priceLineHeight')?.value ?? 1.15);

  document.documentElement.style.setProperty('--name-line-height', String(nameLH));
  document.documentElement.style.setProperty('--price-line-height', String(priceLH));
}

async function downloadAsImage(){
  const target = document.querySelector('.page');
  if(!target){
    alert('æ‰¾ä¸åˆ°è¦ä¸‹è¼‰çš„å€å¡Šï¼ˆ.pageï¼‰');
    return;
  }
  if(typeof html2canvas === 'undefined'){
    alert('ä¸‹è¼‰åœ–ç‰‡éœ€è¦å¯ç”¨çš„ html2canvasï¼ˆè«‹ç¢ºä¿å¯é€£ç¶²è¼‰å…¥ CDNï¼‰');
    return;
  }

  // ä¸‹è¼‰æ™‚éš±è—ï¼šå‰ªåˆ€èˆ‡æ›åœ– icon
  const hideEls = Array.from(document.querySelectorAll('.pic-edit-btn, .pic-replace-btn'));
  const prevDisplays = hideEls.map(el => el.style.display);
  hideEls.forEach(el => el.style.display = 'none');

  const prevSelected = __selectedPicEl;
  document.querySelectorAll('.pic-selected').forEach(x=>x.classList.remove('pic-selected'));

  try{
    const canvas = await html2canvas(target, {scale: 2, useCORS: true, backgroundColor: null});
    const link = document.createElement('a');
    link.download = 'export.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  }catch(e){
    console.error(e);
    alert('ä¸‹è¼‰å¤±æ•—ï¼š' + (e && e.message ? e.message : e));
  }finally{
    // é‚„åŸ icon é¡¯ç¤º
    hideEls.forEach((el, i)=> el.style.display = prevDisplays[i] || '');
    if(prevSelected) setSelectedPic(prevSelected);
  }
}



/* =====================================================
   Excel å·¥å–®ï¼ˆå¯«æ­»åªåƒ MS é ç°½ï¼‰
   - å¾ Aæ¬„æ‰¾åˆ°ã€Œè¦å¹£å¤¾å¤¾æ¨‚å¤§çæ©Ÿå°ã€é‚£ä¸€åˆ—å¾Œé–‹å§‹å¥—ç”¨
   - Aæ¬„ï¼šå°æ‡‰ class/id/selectorï¼ˆè‹¥æ˜¯å¤šå€‹ class ç”¨ç©ºç™½åˆ†éš”ï¼Œæœƒè½‰æˆ .a.bï¼‰
   - Bæ¬„ï¼šå¿½ç•¥
   - Cæ¬„ï¼šå·¦/ç¬¬ä¸€å€‹å€¼
   - Dæ¬„ï¼šå³/ç¬¬äºŒå€‹å€¼ï¼ˆå¯èƒ½ç‚ºç©ºï¼‰
   - ç‰¹è¦ï¼šprize-card çµ„ï¼ˆprize-pic pic-selectable / pill / price-line / count-lineï¼‰
           è‹¥ D æ¬„ç‚ºç©º â†’ è©²çµ„ç½®ä¸­ï¼Œå³å´ prize-card éš±è—
===================================================== */
let __workorderImageKeyToPicEls = new Map();
let __coinImageFileName = 'è¦å¹£icon.png'; // å·¥å–® Aæ¬„=è¦å¹£åœ–ç‰‡ æ™‚ï¼ŒCæ¬„æŒ‡å®šè¦æŠ“çš„æª”å
   // normalized key -> [picEls...]

function normalizeSelectorFromA(a){
  a = (a || '').toString().trim();
  if(!a) return '';
  if(a.startsWith('.') || a.startsWith('#') || a.startsWith('[')) return a;
  if(a.includes('>') || a.includes(':') || a.includes('[') || a.includes('#')) return a;
  const parts = a.split(/\s+/).filter(Boolean);
  if(parts.length === 1) return '.' + parts[0];
  return '.' + parts.join('.');
}

function normalizeKey(s){
  if(!s) return '';
  let t = (''+s).trim().toLowerCase();

  // å»å‰¯æª”å
  t = t.replace(/\.(png|jpe?g|webp|gif)$/i, '');

  // å»å¸¸è¦‹æ•¸é‡/å–®ä½ï¼ˆé¿å…å“åå«è¦æ ¼å°è‡´é…ä¸åˆ°ï¼‰
  t = t.replace(/\d+(?:\.\d+)?\s*(?:g|kg|ml|l|å…¥|åŒ…|ç›’|è¢‹|çµ„|é¡†|ç‰‡)/gi, '');

  // ç§»é™¤æ‰€æœ‰éã€Œä¸­è‹±æ•¸ã€å­—å…ƒï¼ˆåŒ…å«ç©ºç™½ã€/ã€ï¼Œç­‰æ¨™é»ï¼‰
  t = t.replace(/[^0-9a-z\u4e00-\u9fff]+/g, '');

  return t;
}

function setText(el, v){
  if(!el) return;
  const val = (v ?? '').toString();
  if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.value = val;
  else el.textContent = val;
}


function normalizeTextForMatch(s){
  return (s || '').toString()
    .replace(/&nbsp;/g,' ')
    .replace(/\u00a0/g,' ')
    .replace(/\s+/g,' ')
    .trim()
    .toLowerCase();
}
function pickTargetByB(els, bVal){
  if(!els || !els.length) return null;
  const b = normalizeTextForMatch(bVal);
  if(!b) return els[0];
  const hit = els.find(el => normalizeTextForMatch(el.textContent) === b);
  return hit || els[0];
}


function applyPairBySelector(selector, cVal, dVal){
  const els = Array.from(document.querySelectorAll(selector));
  if(!els.length) return;
  if(cVal && cVal.trim() !== '') setText(els[0], cVal);
  if(els.length >= 2 && dVal && dVal.trim() !== '') setText(els[1], dVal);
}

function registerPicKeyForEl(picEl, key){
  const nk = normalizeKey(key);
  if(!nk || !picEl) return;
  if(!__workorderImageKeyToPicEls.has(nk)) __workorderImageKeyToPicEls.set(nk, []);
  __workorderImageKeyToPicEls.get(nk).push(picEl);
}

function clearPrizeCardLayout(){
  document.querySelectorAll('.prize-card.hidden').forEach(el=>el.classList.remove('hidden'));
  document.querySelectorAll('.prize-card.single').forEach(el=>el.classList.remove('single'));
}



function applyWorkorderFromMSWorksheet(ws){
  __workorderImageKeyToPicEls = new Map();
  clearPrizeCardLayout();

  const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});

  // èµ·é»ï¼šå¾ A æ¬„æ‰¾åˆ°é—œéµå­—ã€Œgoã€çš„ä¸‹ä¸€è¡Œé–‹å§‹ï¼ˆå–æœ€å¾Œä¸€å€‹ goï¼‰ï¼›è‹¥æ²’æœ‰å‰‡å¾ç¬¬ä¸€å€‹ A éç©ºé–‹å§‹
  let start = -1;
  const marker = 'start';
  // å–ã€Œç¬¬ä¸€å€‹ã€startï¼ˆç”±ä¸Šå¾€ä¸‹ï¼‰ï¼Œé¿å…å¤šæ®µ start æ™‚æŠ“åˆ°éŒ¯æ®µ
  for(let i=0;i<rows.length;i++){
    const a = (rows[i]?.[0] ?? '').toString().trim();
    if(a && a.toLowerCase() === marker){ start = i + 1; break; }
  }
if(start < 0){
    for(let i=0;i<rows.length;i++){
      const a = (rows[i]?.[0] ?? '').toString().trim();
      if(a){ start = i; break; }
    }
  }
  if(start < 0) start = 0;

  // è‹¥æ‰¾åˆ° start ä½†ä¸‹ä¸€è¡Œå·²è¶…å‡ºç¯„åœï¼Œç›´æ¥å›é€€åˆ°æœ€å¾Œä¸€è¡Œï¼ˆé¿å…ç©ºè®€ï¼‰
  if(start >= rows.length) start = rows.length - 1;

  // ===== 1) tag-barï¼šä¾å·¥å–®å‡ºç¾æ•¸é‡ï¼Œå°æ‡‰æ—¢æœ‰ tag-barï¼›ä¸è¶³å°±è‡ªå‹•æ–°å¢ =====
  const tagBarValues = [];

  // å…ˆæ‰¾ A = tag-bar#start çš„ C æ¬„ï¼Œä½œç‚º tag-bar#1
  let tagBarStartValue = '';
  for(let r=0;r<rows.length;r++){
    const a = (rows[r]?.[0] ?? '').toString().trim().toLowerCase();
    if(a === 'tag-bar#start'){
      tagBarStartValue = (rows[r]?.[2] ?? '').toString().trim(); // C æ¬„
      break; // åªåƒç¬¬ä¸€å€‹
    }
  }
  if(tagBarStartValue) tagBarValues.push(tagBarStartValue);

  // å†å¾ç¬¬ä¸€å€‹ start å¾Œé–‹å§‹å¾€ä¸‹æƒ tag-barï¼›é‡åˆ°ä¸‹ä¸€å€‹ start å°±åœæ­¢ï¼ˆé¿å…åƒåˆ°å¾Œæ®µå€å¡Šçš„ tag-barï¼‰
  for(let r=start;r<rows.length;r++){
    const rawA = (rows[r]?.[0] ?? '').toString().trim().toLowerCase();
    if(rawA === 'start') break;
    if(rawA === 'tag-bar'){
      const cVal = (rows[r]?.[2] ?? '').toString().trim();
      // ä¿æŒåŸæœ¬è¡Œç‚ºï¼šåªæ”¶æœ‰å€¼çš„ C æ¬„
      if(cVal) tagBarValues.push(cVal);
    }
  }
const pageEl = document.querySelector('.page') || document.body;

  // æ¸…æ‰ä¸Šæ¬¡å‹•æ…‹ç”Ÿæˆçš„ tag-barï¼ˆé¿å…é‡è¤‡ä¸Šå‚³å·¥å–®æ™‚è¶Šé•·è¶Šå¤šï¼‰
  pageEl.querySelectorAll('.tag-bar[data-generated="1"]').forEach(el => el.remove());

  // é‡æ–°æŠ“ä¸€æ¬¡æ—¢æœ‰ tag-bar
  let tagEls = Array.from(document.querySelectorAll('.tag-bar'));

  // æ’å…¥éŒ¨é»ï¼šç¬¬ 1 æ®µï¼ˆç¬¬ä¸€å€‹ panel-outerï¼‰/ ç¬¬ 2 æ®µï¼ˆç¬¬äºŒå€‹ panel-outerï¼‰/ æœ€ä¸‹æ–¹èªªæ˜ï¼ˆ.noteï¼‰
  const panelOuters = Array.from(pageEl.querySelectorAll('.panel-outer'));
  const anchors = [
    panelOuters[0] || null,
    panelOuters[1] || null,
    pageEl.querySelector('.note') || null,
  ].filter(Boolean);

  // æ›´æ–°æ—¢æœ‰çš„
  for(let i=0;i<Math.min(tagEls.length, tagBarValues.length);i++){
    setText(tagEls[i], tagBarValues[i]);
  }

  // ä¸è¶³å°±è¤‡è£½æœ€å¾Œä¸€å€‹ tag-barï¼ˆåªæ–°å¢ tag-bar æœ¬èº«ï¼Œä¸å½±éŸ¿æ—¢æœ‰ layoutï¼‰
  // ä½†æ”¹æˆæ’å…¥åˆ°æŒ‡å®šéŒ¨é»å‰ï¼Œè€Œä¸æ˜¯ä¸€å¾‹ append åˆ°é å°¾
  if(tagBarValues.length > tagEls.length){
    const tmpl = tagEls[tagEls.length-1] || null;
    for(let i=tagEls.length;i<tagBarValues.length;i++){
      const el = tmpl ? tmpl.cloneNode(true) : document.createElement('div');
      if(!tmpl) el.className = 'tag-bar';
      el.dataset.generated = '1';
      setText(el, tagBarValues[i]);

      const anchor = anchors[Math.min(i, anchors.length - 1)];
      pageEl.insertBefore(el, anchor);
      tagEls.push(el);
    }
  }


  // ===== 2) ä¾ A/B/C å°æ‡‰ï¼Œå¥—æ–‡å­—åˆ°æ—¢æœ‰ DOMï¼ˆé prize-grid éƒ¨åˆ†ï¼‰=====
  // é€™æ®µç¶­æŒåŸæœ¬åšæ³•ï¼šç”¨ B æ¬„ï¼ˆç›®å‰ html çš„åå­—ï¼‰å®šä½ï¼Œæ‰¾åˆ°åŒä¸€è¡Œå°æ‡‰çš„ classï¼Œå¥— C æ¬„
  const allPicEls = Array.from(document.querySelectorAll('.pic-selectable'));
  const safeTrim = (v)=> (v ?? '').toString().replace(/\u3000/g,' ').trim();

  // big-prize åœ–ç‰‡åœ¨å·¥å–® B æ¬„å¸¸ç„¡æ³•å”¯ä¸€å®šä½ï¼ˆå…©æ ¼éƒ½å«ã€Œåœ–ç‰‡å€ã€ï¼‰ï¼Œå› æ­¤ç”¨å‡ºç¾é †åºä¾†å°æ‡‰
  let __bigPrizePicCursor = 0;
  let __bigPrizeNameCursor = 0;
  let __lastBigPrizePicKey = '';
  let __bigPrizePriceCursor = 0;
  let __bigPrizeBadgeTopCursor = 0;
  let __bigPrizeBadgeBottomCursor = 0;

  // prize-grid æˆ‘å€‘å¾Œé¢é‡å»ºï¼Œå› æ­¤å…ˆç•¥éå…¶å…§æ–‡å¡«å€¼
  const shouldSkipInGeneric = (cls)=> (cls === 'prize-pic pic-selectable' || cls === 'pill' || cls === 'price-line' || cls === 'count-line');

  for(let r=start;r<rows.length;r++){
    const rawA = safeTrim(rows[r]?.[0]);
    const rawB = safeTrim(rows[r]?.[1]);
    const cVal = safeTrim(rows[r]?.[2]);

    if(!rawA) continue;

    // å·¥å–®ç‰¹è¦ï¼šè¦å¹£åœ–ç‰‡ï¼ˆAæ¬„=è¦å¹£åœ–ç‰‡ï¼›Cæ¬„=æª”åï¼Œä¾‹å¦‚ï¼šè¦å¹£.pngï¼‰
    if(rawA === 'è¦å¹£åœ–ç‰‡'){
      if(cVal) __coinImageFileName = cVal;
      continue;
    }
    if(shouldSkipInGeneric(rawA)) continue;

    // æ—¥æœŸè¡Œåªç”¨ä¾†ç”¢ç”Ÿ date-tagï¼ˆåœ¨ prize-grid é‡å»ºç”¨ï¼‰ï¼Œé€™è£¡ç•¥é
    if(rawA === 'big-prize-name' && rawB === 'æ—¥æœŸ') continue;


    // big-prize-picï¼šå…©å€‹åœ–ç‰‡æ¡† B æ¬„æ–‡å­—å¸¸ç›¸åŒï¼Œæ”¹ç”¨å·¥å–®å‡ºç¾é †åºä¾åºå°æ‡‰ç¬¬ 1/2 å€‹ .big-prize-pic
    if(rawA === 'big-prize-pic pic-selectable'){
      const pics = Array.from(document.querySelectorAll('.big-prize-pic'));
      const targetPic = pics[__bigPrizePicCursor] || pics[pics.length - 1];
      __bigPrizePicCursor = Math.min(__bigPrizePicCursor + 1, pics.length);
      if(targetPic && cVal){
        __lastBigPrizePicKey = cVal; // ä¾›å¾ŒçºŒ big-prize-name ç©ºå€¼æ™‚ fallback
        registerPicKeyForEl(targetPic, cVal);
      }
      continue;
    }

    // big-prize-nameï¼šå·¥å–® C æ¬„å¸¸ç‚ºç©ºï¼Œæ”¹ç”¨ä¸Šä¸€å€‹ big-prize-pic çš„ C å€¼ç•¶ fallback
    if(rawA === 'big-prize-name'){
      const names = Array.from(document.querySelectorAll('.big-prize-name'));
      const targetName = names[__bigPrizeNameCursor] || names[names.length - 1];
      __bigPrizeNameCursor = Math.min(__bigPrizeNameCursor + 1, names.length);
      const v = cVal || __lastBigPrizePicKey;
      if(targetName && v) setText(targetName, v);
      continue;
    }

    // é™å®šã€è‡ªå‹•æ‹†å…©è¡Œï¼ˆtop/bottomï¼‰
// badge-top åœ¨å¤§çå€æœ‰å…©çµ„ï¼Œéœ€ä¾å‡ºç¾é †åºå°æ‡‰åˆ°ç¬¬ 1 / ç¬¬ 2 çµ„
if(rawA === 'badge-top'){
  const tops = Array.from(document.querySelectorAll('.big-prize .badge-top'));
  const targetTop = tops[__bigPrizeBadgeTopCursor] || tops[tops.length - 1];
  __bigPrizeBadgeTopCursor = Math.min(__bigPrizeBadgeTopCursor + 1, tops.length);
  if(!targetTop) continue;

  const parts = cVal.split(/\s+/).filter(Boolean);
  const top = parts[0] || '';
  const bottom = parts.slice(1).join('') || '';

  setText(targetTop, top);

  const badge = targetTop.closest('.limit-badge') ? targetTop.closest('.limit-badge') : null;
  const bottomEl = badge ? badge.querySelector('.badge-bottom') : null;
  if(bottomEl) setText(bottomEl, bottom);
  continue;
}


    // ä¸€èˆ¬ classï¼šå„ªå…ˆç”¨ B æ¬„åœ¨ç•«é¢ä¸Šæ‰¾åˆ°å°æ‡‰ç¯€é»ï¼ˆæ–‡å­—ç›¸ç­‰è€…ï¼‰
    let target = null;
    if(rawB){
      const candidates = Array.from(document.querySelectorAll('.' + rawA.split(' ')[0].replace(/\./g,'')));
      // ä»¥æ–‡å­—å‘½ä¸­ç‚ºä¸»
      for(const el of candidates){
        const t = safeTrim(el.textContent);
        if(t && t === rawB){ target = el; break; }
      }
    }
    // æ‰¾ä¸åˆ°å°± fallbackï¼šç¬¬ä¸€å€‹åŒ¹é… class
    if(!target){
      target = document.querySelector('.' + rawA.split(' ')[0].replace(/\./g,''));
    }
    if(!target) continue;

    // åœ–ç‰‡é¡ï¼šåªç™»è¨˜ key -> å…ƒç´ ï¼Œç­‰ä¸Šå‚³åœ–ç‰‡æ™‚ç”¨ã€ŒåŒ…å«ã€åŒ¹é…
    if(rawA.includes('pic-selectable')){
      if(cVal){
        registerPicKeyForEl(target, cVal);
      }
      // è‹¥æ–‡å­—æ˜¯ placeholderï¼Œä¸æ¸…ç©º badgeï¼Œåƒ…ç§»é™¤ placeholderï¼ˆç”±ä¸Šå‚³åœ–ç‰‡æ™‚è™•ç†ï¼‰
      continue;
    }

    // big-prize-priceï¼šå¯æ‹†ã€Œåƒ¹å€¼ / å…±Xåã€
    if(rawA === 'big-prize-price'){
      const prices = Array.from(document.querySelectorAll('.big-prize-price'));
      const targetPrice = prices[__bigPrizePriceCursor] || prices[prices.length - 1];
      __bigPrizePriceCursor = Math.min(__bigPrizePriceCursor + 1, prices.length);

      if(targetPrice){
        const lines = cVal.split(/\n+/).map(s=>safeTrim(s)).filter(Boolean);
        const priceLine = lines[0] || cVal;
        const infoLine = lines[1] || '';
        if(priceLine) setText(targetPrice, priceLine);
        const infoEl = targetPrice.parentElement ? targetPrice.parentElement.querySelector('.big-prize-info') : null;
        if(infoEl && infoLine) setText(infoEl, infoLine);
      }
      continue;
    }

    // å…¶ä»–æ–‡å­—
    if(cVal) setText(target, cVal);
  }

  // ===== 3) prize-gridï¼šæ¯ 4 è¡Œç‚ºä¸€æ’ï¼ˆprize-pic / pill / price-line / count-lineï¼‰ï¼Œè‡ªå‹•æ–°å¢å¤šæ’ï¼›ä¸­é–“æ’å…¥ date-tag =====
  
  // ===== 3) prize-gridï¼šä¾å·¥å–®ç”±ä¸Šåˆ°ä¸‹ä¸²æµæ¸²æŸ“ï¼ˆdate-tag ç‚ºç¨ç«‹ä¸€è¡Œï¼‰=====
  const firstGrid = document.querySelector('.prize-grid');
  if(firstGrid){
    const panel = firstGrid.parentElement;
    const dateTmpl = panel ? panel.querySelector('.date-tag') : null;

    // end markerï¼šåŸæœ¬ prize-grid å¾Œé¢ç·Šæ¥çš„ä¸‹ä¸€æ®µï¼ˆé€šå¸¸æ˜¯ä¸‹ä¸€å€‹ section-title / coin å€å¡Šï¼‰
    const endMarker = firstGrid.nextElementSibling;

    // ===== 3-1) è§£æå·¥å–®ï¼šé‡åˆ° date-tag é–‹æ–°æ®µï¼Œé‡åˆ° prize-pic ç”¢ç”Ÿä¸€æ’å•†å“ï¼ˆå·¦å³å„ä¸€å¼µï¼‰=====
    let p = start;
    // æ‰¾åˆ° prize å€å¡Šçš„ç¬¬ä¸€å€‹ date-tag æˆ– prize-pic
    while(p < rows.length){
      const a = safeTrim(rows[p]?.[0]);
      if(a === 'date-tag' || a === 'prize-pic pic-selectable') break;
      p++;
    }

    // è®€åˆ°é‡åˆ°ä¸‹ä¸€å€‹ä¸»è¦æ®µè½ï¼ˆè¦å¹£æ®µ / ä¸‹ä¸€å€‹ tag-barï¼‰å°±åœæ­¢
    const stopAt = (idx)=>{
      const a = safeTrim(rows[idx]?.[0]);
      const c = safeTrim(rows[idx]?.[2]);
      if(a === 'tag-bar') return true;
      if(a === 'section-title' && c === 'è¦å¹£') return true;
      return false;
    };

    const segments = [];
    let curDate = '';
    let curItems = [];

    const pushSeg = ()=>{
      if(curDate || curItems.length){
        segments.push({ date: curDate, items: curItems });
      }
    };

    while(p < rows.length && !stopAt(p)){
      const a = safeTrim(rows[p]?.[0]);
      const b = safeTrim(rows[p]?.[1]);
      const c = safeTrim(rows[p]?.[2]);
      const d = safeTrim(rows[p]?.[3]);

      if(a === 'date-tag' && c){
        pushSeg();
        curDate = c;
        curItems = [];
        p++;
        continue;
      }

      if(a !== 'prize-pic pic-selectable'){ p++; continue; }

      // è®€é€™ä¸€æ’ï¼ˆprize-pic / pill / price-line / count-lineï¼‰ï¼Œä¸­é€”è‹¥é‡åˆ°ä¸‹ä¸€å€‹ date-tag æˆ–ä¸‹ä¸€å€‹ prize-pic å°±çµæŸ
      const rowPic = { L: c, R: d };

      let pillRowIdx = null, priceRowIdx = null, countRowIdx = null;
      let nextP = p + 1;
      for(let i=p+1;i<rows.length && i<p+10;i++){
        const a2 = safeTrim(rows[i]?.[0]);
        if(a2 === 'date-tag' || a2 === 'prize-pic pic-selectable'){
          nextP = i;
          break;
        }
        if(!pillRowIdx && a2 === 'pill'){ pillRowIdx = i; }
        if(!priceRowIdx && a2 === 'price-line'){ priceRowIdx = i; }
        if(!countRowIdx && a2 === 'count-line'){ countRowIdx = i; nextP = i + 1; break; }
        nextP = i + 1;
      }

      const pillRow = (pillRowIdx != null) ? rows[pillRowIdx] : [];
      const priceRow = (priceRowIdx != null) ? rows[priceRowIdx] : [];
      const countRow = (countRowIdx != null) ? rows[countRowIdx] : [];

      const pillL = safeTrim(pillRow[2]) || rowPic.L;   // å·¥å–®å¸¸ç©ºï¼šfallback ç”¨åœ–ç‰‡ key
      const pillR = safeTrim(pillRow[3]) || rowPic.R;
      const priceL = safeTrim(priceRow[2]);
      const priceR = safeTrim(priceRow[3]);
      const countL = safeTrim(countRow[2]);
      const countR = safeTrim(countRow[3]);

      curItems.push({
        L: { picKey: rowPic.L, pill: pillL, price: priceL, count: countL },
        R: { picKey: rowPic.R, pill: pillR, price: priceR, count: countR },
      });

      p = nextP;
    }
    pushSeg();

    // ===== 3-2) æ¸…æ‰èˆŠçš„ date-tag / prize-gridï¼ˆåªæ¸… prize å€å¡Šç¯„åœï¼Œä¸å‹•å…¶ä»–æ®µè½ï¼‰=====
    // è‹¥æ‰¾å¾—åˆ° endMarkerï¼Œå‰‡ç§»é™¤ dateTmpl ~ endMarker ä¹‹å‰çš„æ‰€æœ‰ date-tag / prize-grid
    if(panel){
      const startNode = dateTmpl || firstGrid;
      if(endMarker){
        let n = startNode;
        while(n && n !== endMarker){
          const next = n.nextElementSibling;
          n.remove();
          n = next;
        }
      }else{
        // fallbackï¼šåªæ¸…æ‰ panel å…§æ‰€æœ‰ date-tag / prize-grid
        panel.querySelectorAll('.date-tag, .prize-grid').forEach(el=>el.remove());
      }

      // ===== 3-3) ä¾ segments é€æ®µæ’å…¥ï¼šdate-tagï¼ˆç¨ç«‹ä¸€è¡Œï¼‰+ prize-gridï¼ˆå¤šæ’ï¼‰=====
      const makeCard = (pill, price, count, picKey)=>{
        const card = document.createElement('div');
        card.className = 'prize-card';
        const pic = document.createElement('div');
        pic.className = 'prize-pic pic-selectable';
        pic.innerHTML = '<div class="pic-placeholder">åœ–ç‰‡å€</div>';
        const pillEl = document.createElement('div');
        pillEl.className = 'pill';
        pillEl.textContent = pill || 'å“å';
        const priceEl = document.createElement('div');
        priceEl.className = 'price-line';
        priceEl.textContent = price || 'åƒ¹å€¼ $000';
        const countEl = document.createElement('div');
        countEl.className = 'count-line';
        countEl.textContent = count || 'å…± 000 å';

        card.appendChild(pic);
        card.appendChild(pillEl);
        card.appendChild(priceEl);
        card.appendChild(countEl);

        if(picKey){
          registerPicKeyForEl(pic, picKey);
        }
        return card;
      };

      const insertBeforeNode = endMarker || null;

      segments.forEach(seg=>{
        // date-tagï¼šä¿æŒèˆ‡ç¬¬ä¸€è¡Œç›¸åŒçš„ã€Œç¨ç«‹ä¸€è¡Œã€æ¨£å¼ï¼ˆclone æ¨¡æ¿ï¼Œä¸æ”¹ styleï¼‰
        const dt = dateTmpl ? dateTmpl.cloneNode(true) : document.createElement('div');
        dt.className = 'date-tag';
        dt.textContent = seg.date || '';
        panel.insertBefore(dt, insertBeforeNode);

        const gridEl = document.createElement('div');
        gridEl.className = 'prize-grid';

        (seg.items || []).forEach(row=>{
          if(row.L && row.L.picKey) gridEl.appendChild(makeCard(row.L.pill, row.L.price, row.L.count, row.L.picKey));
          if(row.R && row.R.picKey) gridEl.appendChild(makeCard(row.R.pill, row.R.price, row.R.count, row.R.picKey));
        });

        panel.insertBefore(gridEl, insertBeforeNode);
      });
    }
  }

  // é‡æ–°ç¶å®šï¼šå‹•æ…‹æ–°å¢çš„ pic-selectable éœ€è¦é¸å–èˆ‡å‰ªåˆ€ UI
  initPicSelection();

  // ====== è£œï¼šåœ–ç‰‡æ‰‹å‹•æ›åœ–æŒ‰éˆ•ï¼ˆå‰ªåˆ€ä¸‹æ–¹ï¼‰ ======
  (function initPicReplaceButton(){
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.style.display = 'none';
    document.body.appendChild(input);

    let pendingPicEl = null;
    input.addEventListener('change', ()=>{
      const f = input.files && input.files[0];
      if(f && pendingPicEl){
        applyImageToPicEl(pendingPicEl, f);
      }
      pendingPicEl = null;
      input.value = '';
    });

    document.querySelectorAll('.pic-selectable').forEach(picEl=>{
      // é¿å…é‡è¤‡å»ºç«‹
      if(picEl.querySelector('.pic-replace-btn')) return;

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'pic-replace-btn';
      btn.setAttribute('aria-label', 'æ›åœ–');
      btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0114.13-3.36L23 10M1 14l5.36 4.36A9 9 0 0020.49 15"></path></svg>`;

      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        pendingPicEl = picEl;
        input.click();
      });

      picEl.appendChild(btn);
    });
  })();

  ensurePicEditorUI();

}



function applyImageToPicEl(picEl, file){
  // å…ˆåˆ¤æ–·ï¼šè‹¥ä¸Šå‚³çš„æ˜¯ã€Œè¦å¹£åœ–ç‰‡æª”ã€ï¼ˆå·¥å–®æŒ‡å®šæª”åï¼‰ï¼Œåªå…è¨±å¥—ç”¨åˆ° coin å€å¡Šï¼Œé¿å…èª¤å¥—åˆ°å•†å“åœ–/åç¨±
  const expectedCoinKey = normalizeKey(__coinImageFileName || 'è¦å¹£icon.png');
  const fileKey = normalizeKey(file?.name || '');
  const isCoinFile = (expectedCoinKey && fileKey && fileKey === expectedCoinKey);

  // ä¿è­·æ¨™è¨˜çš„åœ–ç‰‡ï¼ˆä¾‹å¦‚è¦å¹£ iconï¼‰ï¼š
  // - åªæœ‰ç•¶ä¸Šå‚³æª”åç¬¦åˆã€Œå·¥å–®æŒ‡å®šçš„æª”åã€(Aæ¬„=è¦å¹£åœ–ç‰‡ çš„ Cæ¬„) æ™‚ï¼Œæ‰å…è¨±æ›¿æ›è©² <img>
  // - è‹¥å·¥å–®æœªæŒ‡å®šï¼Œé è¨­ä»ç‚ºã€Œè¦å¹£icon.pngã€
  // - å…¶ä»–æƒ…æ³ä¸€å¾‹ä¸å‹•
  const protectedImg = picEl && picEl.querySelector && picEl.querySelector('[data-protect-image="1"]');
  if(protectedImg){
    if(isCoinFile){
      const url = URL.createObjectURL(file);
      protectedImg.src = url;
    }
    return;
  }

  // è‹¥æ˜¯è¦å¹£åœ–ç‰‡æª”ä½†ç›®å‰ä¸æ˜¯ coin å€å¡Šï¼Œç›´æ¥ç•¥éï¼ˆé¿å…èª¤å¥—åˆ°å•†å“åœ–ï¼‰
  if(isCoinFile) return;

  const url = URL.createObjectURL(file);
  picEl.dataset.originalUrl = url;      // ä¾›å‰ªè£ä½¿ç”¨
  picEl.dataset.originalName = file.name || '';
  picEl.style.backgroundImage = `url("${url}")`;
  picEl.style.backgroundSize = 'cover';
  picEl.style.backgroundPosition = 'center';
  // åªç§»é™¤åœ–ç‰‡å€ placeholderï¼Œä¸è¦æŠŠå¾½ç« ç­‰å­ç¯€é»æ¸…æ‰
  const ph = picEl.querySelector('.pic-placeholder');
  if(ph) ph.remove();
  // æ¸…æ‰æ®˜ç•™çš„ç´”æ–‡å­—ç¯€é»ï¼ˆé¿å…å½±éŸ¿æ’ç‰ˆï¼‰
  [...picEl.childNodes].forEach(n => {
    if(n.nodeType === Node.TEXT_NODE && !n.textContent.trim()) n.textContent = '';
    if(n.nodeType === Node.TEXT_NODE && n.textContent.trim()) n.textContent = '';
  });
}


function findTargetsFromWorkorderByFile(fileName){
  const nk = normalizeKey(fileName);
  if(!nk) return [];

  // è¦å¹£ icon æª”ååªå…è¨±å¥—ç”¨åœ¨æŒ‡å®šå€å¡Šï¼ˆ.coin-image-wrapï¼‰ï¼Œä¸åƒèˆ‡å•†å“åœ–/å·¥å–®å°æ‡‰
  const expectedCoinName = normalizeKey(__coinImageFileName || 'è¦å¹£icon.png');
  if(expectedCoinName && nk === expectedCoinName) return [];


  // 1) ç²¾æº–æ¯”å°
  if(__workorderImageKeyToPicEls.has(nk)) return __workorderImageKeyToPicEls.get(nk);

  // 2) æ¨¡ç³Šæ¯”å°ï¼ˆåŠ ä¸Šã€Œæœ€ä½³åˆ†æ•¸ã€æŒ‘é¸ï¼Œé¿å…åŒå‰ç¶´å•†å“èª¤é…ï¼Œä¾‹å¦‚ KANGOL*ï¼‰
  const MIN_FUZZY_LEN = 2;
  if(nk.length < MIN_FUZZY_LEN) return [];

  // æœ€é•·å…±åŒå­å­—ä¸²é•·åº¦ï¼ˆç”¨ä¾†åˆ†è¾¨åŒå‰ç¶´çš„å·®ç•°ï¼‰
  function lcsLen(a,b){
    const n=a.length, m=b.length;
    const dp = new Array(m+1).fill(0);
    let best=0;
    for(let i=1;i<=n;i++){
      let prev=0;
      for(let j=1;j<=m;j++){
        const tmp = dp[j];
        if(a[i-1] === b[j-1]){
          dp[j] = prev + 1;
          if(dp[j] > best) best = dp[j];
        }else{
          dp[j] = 0;
        }
        prev = tmp;
      }
    }
    return best;
  }

  let bestEls = [];
  let bestScore = -1;
  let bestKeyLen = -1;

  for(const [k, els] of __workorderImageKeyToPicEls.entries()){
    if(!k || k.length < MIN_FUZZY_LEN) continue;

    let score = -1;

    // 2a) äº’åŒ…å«ï¼šä»¥ã€Œå‘½ä¸­é•·åº¦ã€ç•¶åˆ†æ•¸ï¼ˆå‘½ä¸­è¶Šé•·è¶Šå„ªå…ˆï¼‰
    if(k.includes(nk) || nk.includes(k)){
      score = Math.min(k.length, nk.length);
    }else{
      // 2b) å­å­—ä¸²å‘½ä¸­ï¼šå–æœ€å¤§é€£çºŒå‘½ä¸­é•·åº¦ï¼ˆé–€æª» 4ï¼‰
      const common = lcsLen(k, nk);
      if(common >= 4) score = common;
    }

    if(score > bestScore || (score === bestScore && k.length > bestKeyLen)){
      bestScore = score;
      bestKeyLen = k.length;
      bestEls = els;
    }
  }

  return bestEls || [];
}

document.addEventListener('DOMContentLoaded', ()=>{
  initPicSelection();
  ensurePicEditorUI();
  applyBadgeText();
  applyBadgeStyle();
  applyTextLineHeight();

  // ====== æ˜ç¢ºè£œä¸Šï¼šcoin-btn å…§å®¹å¯ç·¨è¼¯ ======
  document.querySelectorAll('.coin-btn, .coin-btn *').forEach(el=>{
    if(el.closest('.toolbar-float') || el.closest('.detail-panel') || el.closest('.crop-modal')) return;
    el.setAttribute('contenteditable', 'true');
    el.setAttribute('spellcheck', 'false');
  });


  // ====== å…¨é æ‰€æœ‰æ–‡å­—å¯ç›´æ¥ç·¨è¼¯ï¼ˆä¸æ”¹æ¨£å¼/ä¸æ”¹ç‰ˆé¢ï¼›ç•¥éå·¥å…·åˆ—/å½ˆçª—/æŒ‰éˆ•/è¼¸å…¥ç­‰ï¼‰ ======
  (function makeAllTextEditable(){
    const root = document.querySelector('.page') || document.body;
    const SKIP_TAGS = new Set(['BUTTON','INPUT','TEXTAREA','SELECT','OPTION','SCRIPT','STYLE','CANVAS','SVG','PATH','IMG']);
    const SKIP_WITHIN = ['.toolbar-float', '.detail-panel', '.crop-modal'];

    function isInsideSkipArea(el){
      return SKIP_WITHIN.some(sel => el.closest(sel));
    }
    function hasTextNode(el){
      for(const n of el.childNodes){
        if(n.nodeType === Node.TEXT_NODE && (n.textContent || '').trim() !== '') return true;
      }
      return false;
    }
    function walk(el){
      if(!el || el.nodeType !== 1) return;
      if(SKIP_TAGS.has(el.tagName)) return;
      if(isInsideSkipArea(el)) return;

      if(hasTextNode(el)){
        el.setAttribute('contenteditable', 'true');
        el.setAttribute('spellcheck', 'false');
      }
      for(const child of el.children) walk(child);
    }
    walk(root);
  })();

  // ====== è£œå¼·ï¼šå‹•æ…‹ç”¢ç”Ÿçš„æ–‡å­—ï¼ˆä¾‹å¦‚ç¬¬äºŒå€ prize-gridï¼‰ä¹Ÿè¨­ç‚ºå¯ç·¨è¼¯ ======
  (function observeEditableText(){
    const root = document.querySelector('.page') || document.body;
    const SKIP_TAGS = new Set(['BUTTON','INPUT','TEXTAREA','SELECT','OPTION','SCRIPT','STYLE','CANVAS','SVG','PATH','IMG']);
    const SKIP_WITHIN = ['.toolbar-float', '.detail-panel', '.crop-modal'];

    function isInsideSkipArea(el){
      return SKIP_WITHIN.some(sel => el.closest(sel));
    }
    function hasTextNode(el){
      for(const n of el.childNodes){
        if(n.nodeType === Node.TEXT_NODE && (n.textContent || '').trim() !== '') return true;
      }
      return false;
    }
    function applyEditable(el){
      if(!el || el.nodeType !== 1) return;
      if(SKIP_TAGS.has(el.tagName)) return;
      if(isInsideSkipArea(el)) return;
      if(hasTextNode(el)){
        el.setAttribute('contenteditable', 'true');
        el.setAttribute('spellcheck', 'false');
      }
    }

    // åˆå§‹æƒæ
    root.querySelectorAll('*').forEach(applyEditable);

    // ç›£è½ä¹‹å¾Œå‹•æ…‹åŠ å…¥çš„ç¯€é»ï¼ˆå·¥å–®ç”¢ç”Ÿçš„ç¬¬äºŒå€ï¼‰
    const mo = new MutationObserver(muts=>{
      muts.forEach(m=>{
        m.addedNodes && m.addedNodes.forEach(n=>{
          if(n.nodeType === 1){
            applyEditable(n);
            n.querySelectorAll && n.querySelectorAll('*').forEach(applyEditable);
          }
        });
      });
    });
    mo.observe(root, { childList: true, subtree: true });
  })();


  const imageInput = document.getElementById('imageInput');
  if(imageInput){
    imageInput.addEventListener('change', (e)=>{
      const files = Array.from(e.target.files || []);
      if(!files.length) return;

      let used = 0;
      
for(const f of files){
        // è¦å¹£åœ–ç‰‡ï¼šç”±å·¥å–®æŒ‡å®šæª”åï¼ˆAæ¬„=è¦å¹£åœ–ç‰‡ï¼›Cæ¬„=æª”åï¼Œä¾‹å¦‚ï¼šè¦å¹£.pngï¼‰
        const expectedCoinKey = normalizeKey(__coinImageFileName || 'è¦å¹£icon.png');
        const isCoinIcon = (normalizeKey(f.name) === expectedCoinKey);

        if(isCoinIcon){
          const coinImg = document.querySelector('.coin-image-wrap img[data-protect-image="1"]');
          if(coinImg){
            coinImg.src = URL.createObjectURL(f);
            used++;
          }
          // ä¸å¥—ç”¨åˆ°å•†å“åœ–ç‰‡æ¡†
          continue;
        }

        const targets = findTargetsFromWorkorderByFile(f.name);
        if(targets && targets.length){
          targets.forEach(t => applyImageToPicEl(t, f));
          used++;
        }

        // æ–‡å­—ä¸­çš„æª”åï¼ˆä¾‹å¦‚ã€Œç¦.pngã€ï¼‰â†’ æ›¿æ›ç‚ºåœ–ç‰‡
        const url = URL.createObjectURL(f);
        document.querySelectorAll('.page').forEach(root=>{
          if(((f.name || '').toLowerCase() === 'ç¦.png')){
            replaceInlineFilenameWithImage(root, f.name, url);
          }
        });
      }

      if(used === 0){

        if(!__selectedPicEl){
          alert('è«‹å…ˆä¸Šå‚³å·¥å–®ï¼ˆç”¨æª”åå°æ‡‰ï¼‰æˆ–å…ˆé»é¸è¦å¥—ç”¨åœ–ç‰‡çš„åœ–ç‰‡å€ï¼Œå†ä¸Šå‚³åœ–ç‰‡ã€‚');
          return;
        }
        applyImageToPicEl(__selectedPicEl, files[0]);
      }
    });
  }

  const workorderInput = document.getElementById('workorderInput');
  if(workorderInput){
    workorderInput.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const name = (file.name || '').toLowerCase();

      try{
        if(name.endsWith('.xlsx') || name.endsWith('.xls')){
          if(typeof XLSX === 'undefined'){
            alert('å·¥å–®è®€å–éœ€è¦ XLSX è§£æåº«ï¼ˆè«‹ç¢ºä¿å¯é€£ç¶²è¼‰å…¥ xlsx CDNï¼‰');
            return;
          }
          const ab = await file.arrayBuffer();
          const wb = XLSX.read(ab, {type:'array'});

          const msName = wb.SheetNames.find(n => n.trim().toLowerCase() === 'ms');
          if(!msName){
            alert('å·¥å–®è®€å–å¤±æ•—ï¼šæ‰¾ä¸åˆ°é ç°½ã€ŒMSã€');
            return;
          }
          const ws = wb.Sheets[msName];

          applyWorkorderFromMSWorksheet(ws);
          alert('å·¥å–®å·²ä¸Šå‚³ä¸¦å¥—ç”¨ï¼ˆExcel / MSï¼‰ã€‚');
        }else{
          const text = await file.text();
          let data = null;
          try{ data = JSON.parse(text); }catch(_){ data = { raw: text }; }
          if(data && data.raw){
            alert('å·¥å–®å·²ä¸Šå‚³ï¼ˆtxtï¼‰ã€‚è¦è‡ªå‹•å¥—ç”¨è«‹ç”¨ Excelï¼ˆMS é ç°½ï¼‰ã€‚');
          }else{
            applyWorkorder(data);
            alert('å·¥å–®å·²ä¸Šå‚³ä¸¦å¥—ç”¨ï¼ˆJSONï¼‰ã€‚');
          }
        }
      }catch(err){
        console.error(err);
        alert('å·¥å–®è®€å–å¤±æ•—ï¼š' + (err && err.message ? err.message : err));
      }
    });
  }
});
</script>
<script>
function changeFontSizeDelta(selector, delta) {
  const els = document.querySelectorAll(selector);
  els.forEach(el => {
    const cs = window.getComputedStyle(el);
    const current = parseFloat(cs.fontSize);
    if (isNaN(current)) return;
    let next = current + delta;
    if (next < 8) next = 8;
    if (next > 80) next = 80;
    el.style.fontSize = next + 'px';
  });
}
function setFontSizeFromInput(input, selector) {
  let val = parseFloat(input.value);
  if (isNaN(val)) return;
  if (val < 8) val = 8;
  if (val > 80) val = 80;
  input.value = val;
  const els = document.querySelectorAll(selector);
  els.forEach(el => {
    el.style.fontSize = val + 'px';
  });
}
</script>
</body>
</html>
